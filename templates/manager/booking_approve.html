{% extends 'base.html' %}

{% block title %}预约审批 - 江南大学实验室设备管理系统{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <a href="{% url 'manager_home' %}">首页</a>
    <a href="{% url 'manager_booking_approve' %}" class="active">校外人员预约审批</a>
    <a href="{% url 'device_manage' %}">设备管理</a>
    <a href="{% url 'user_manage' %}">用户管理</a>
    <a href="{% url 'ledger:ledger_home' %}">台账</a>
    <a href="{% url 'manager_report_stat' %}">报表统计</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>设备预约申请审批</h2>
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 10px; margin: 15px 0; border-radius: 4px; 
                {% if message.tags == 'success' %}background-color: #d4edda; color: #155724;{% endif %}
                {% if message.tags == 'error' %}background-color: #f8d7da; color: #721c24;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- 用户类型筛选 -->
    <div style="margin-bottom: 20px;">
        <a href="{% url 'manager_booking_approve' %}?user_type=all" class="btn {% if user_type_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">全部待审批</a>
        <a href="{% url 'manager_booking_approve' %}?user_type=teacher" class="btn {% if user_type_filter == 'teacher' %}btn-primary{% else %}btn-secondary{% endif %}">校内教师申请</a>
        <a href="{% url 'manager_booking_approve' %}?user_type=student" class="btn {% if user_type_filter == 'student' %}btn-primary{% else %}btn-secondary{% endif %}">校内学生申请</a>
        <a href="{% url 'manager_booking_approve' %}?user_type=external" class="btn {% if user_type_filter == 'external' %}btn-primary{% else %}btn-secondary{% endif %}">校外人员申请</a>
    </div>

    <form method="post">
        {% csrf_token %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 8px; border: 1px solid #dee2e6;">选择</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">预约编号</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">申请人</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">用户类型</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">设备编号</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">预约时段</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">设备状态</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">当前状态</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">审批操作</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <input type="checkbox" name="booking_ids" value="{{ booking.id }}">
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.booking_code }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.applicant.name }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        {% if booking.applicant.user_type == 'student' %}校内学生
                        {% elif booking.applicant.user_type == 'teacher' %}校内教师
                        {% else %}校外人员{% endif %}
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.device.device_code }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.booking_date }} {{ booking.time_slot }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        {% if booking.device.status == 'available' %}
                            <span style="color: green; font-weight: bold;">{{ booking.device.get_status_display }}</span>
                        {% elif booking.device.status == 'maintenance' %}
                            <span style="color: orange; font-weight: bold;">{{ booking.device.get_status_display }}</span>
                        {% elif booking.device.status == 'discarded' %}
                            <span style="color: #999; font-weight: bold;">{{ booking.device.get_status_display }}</span>
                        {% else %}
                            <span>{{ booking.device.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.get_status_display }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        {% if is_admin %}
                            <button type="submit" name="approve" value="{{ booking.id }}" class="btn btn-success btn-sm">批准</button>
                            <button type="submit" name="reject" value="{{ booking.id }}" class="btn btn-danger btn-sm">拒绝</button>
                        {% elif is_manager %}
                            <button type="submit" name="approve" value="{{ booking.id }}" class="btn btn-success btn-sm">最终批准</button>
                            <button type="submit" name="reject" value="{{ booking.id }}" class="btn btn-danger btn-sm">拒绝</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">暂无待审批的申请</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if bookings %}
        <div style="margin-top: 20px;">
            <button type="submit" name="batch_approve" class="btn btn-success">批量批准</button>
            <button type="submit" name="batch_reject" class="btn btn-danger" style="margin-left: 10px;">批量拒绝</button>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}