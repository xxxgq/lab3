{% extends 'base.html' %}

{% block title %}è´Ÿè´£äººæŠ¥è¡¨ç»Ÿè®¡ - æ±Ÿå—å¤§å­¦å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <a href="{% url 'manager_home' %}">é¦–é¡µ</a>
    <a href="{% url 'manager_booking_approve' %}">æ ¡å¤–äººå‘˜é¢„çº¦å®¡æ‰¹</a>
    <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
    <a href="{% url 'user_manage' %}">ç”¨æˆ·ç®¡ç†</a>
    <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
    <a href="{% url 'manager_report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>å®éªŒå®¤è´Ÿè´£äºº - è®¾å¤‡ä½¿ç”¨æŠ¥è¡¨ç»Ÿè®¡</h2>
    
    <!-- è‡ªåŠ¨ç”Ÿæˆè¯´æ˜ -->
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #3498db; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #2980b9;">ğŸ“… è‡ªåŠ¨ç”Ÿæˆè¯´æ˜</h4>
        <p style="margin: 5px 0; color: #555; line-height: 1.6;">
            â€¢ <strong>ç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆæŠ¥è¡¨</strong>ï¼š
              <span style="margin-left: 20px;">- å‘¨æŠ¥è¡¨ï¼šæ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€å‘¨æŠ¥è¡¨</span><br>
              <span style="margin-left: 20px;">- æœˆæŠ¥è¡¨ï¼šæ¯æœˆ1å·å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€æœˆæŠ¥è¡¨</span><br>
              <span style="margin-left: 20px;">- å¹´æŠ¥è¡¨ï¼šæ¯å¹´1æœˆ1å·å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€å¹´æŠ¥è¡¨</span><br>
            â€¢ <strong>æŠ¥è¡¨è‡ªåŠ¨æ¸…ç†</strong>ï¼šè¶…è¿‡30å¤©çš„æŠ¥è¡¨ä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼‰<br>
            â€¢ <strong>æ‰‹åŠ¨ç”Ÿæˆ</strong>ï¼šæ‚¨å¯ä»¥æ‰‹åŠ¨ç”ŸæˆæŒ‡å®šæ—¶é—´æ®µçš„æŠ¥è¡¨ï¼ˆæ”¯æŒè‡ªå®šä¹‰èµ·å§‹å’Œç»“æŸæ—¥æœŸï¼‰
        </p>
    </div>
    
    <!-- æ‰‹åŠ¨ç”ŸæˆæŠ¥è¡¨è¡¨å• -->
    <div style="margin-bottom: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
        <h3 style="margin-bottom: 15px;">ğŸ”§ æ‰‹åŠ¨ç”ŸæˆæŠ¥è¡¨</h3>
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
            æç¤ºï¼šå¦‚æœç³»ç»Ÿå·²è‡ªåŠ¨ç”Ÿæˆè¯¥æ—¶é—´æ®µçš„æŠ¥è¡¨ï¼ˆå‘¨/æœˆ/å¹´ï¼‰ï¼Œç³»ç»Ÿä¼šæç¤ºå¹¶ç›´æ¥åŠ è½½å·²å­˜åœ¨çš„æŠ¥è¡¨ã€‚è‡ªå®šä¹‰æ—¶é—´æ®µæŠ¥è¡¨å¯é‡å¤ç”Ÿæˆã€‚
        </p>
        <form method="post" id="report_form">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px;">æŠ¥è¡¨ç±»å‹ï¼š</label>
                    <select name="report_type" class="form-control" required style="width: 100%;" id="report_type_select">
                        <option value="week">å‘¨æŠ¥è¡¨</option>
                        <option value="month">æœˆæŠ¥è¡¨</option>
                        <option value="year">å¹´æŠ¥è¡¨</option>
                        <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µæŠ¥è¡¨</option>
                    </select>
                </div>
                <div id="date_input_div">
                    <label style="display: block; margin-bottom: 5px;">æ—¥æœŸï¼š</label>
                    <input type="text" name="date_input" class="form-control" 
                           placeholder="å‘¨æŠ¥è¡¨: YYYY-MM-DD, æœˆæŠ¥è¡¨: YYYY-MM, å¹´æŠ¥è¡¨: YYYY"
                           style="width: 100%;" id="date_input">
                    <small style="color: #666; display: block; margin-top: 5px;" id="date_hint">
                        å‘¨æŠ¥è¡¨ï¼šé€‰æ‹©æ—¥æœŸï¼ˆå¦‚ 2025-01-10ï¼‰<br>
                        æœˆæŠ¥è¡¨ï¼šé€‰æ‹©æœˆä»½ï¼ˆå¦‚ 2025-01ï¼‰<br>
                        å¹´æŠ¥è¡¨ï¼šè¾“å…¥å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰
                    </small>
                </div>
                <div id="start_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">èµ·å§‹æ—¥æœŸï¼š</label>
                    <input type="date" name="start_date" class="form-control" style="width: 100%;" id="start_date">
                </div>
                <div id="end_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" name="end_date" class="form-control" style="width: 100%;" id="end_date">
                </div>
            </div>
            <div>
                <button type="submit" name="generate" class="btn btn-primary">ç”ŸæˆæŠ¥è¡¨</button>
            </div>
        </form>
    </div>
    
    <!-- å·²ç”ŸæˆæŠ¥è¡¨åˆ—è¡¨ -->
    <div style="margin-bottom: 30px;">
        <h3>ğŸ“‹ å·²ç”ŸæˆæŠ¥è¡¨åˆ—è¡¨</h3>
        <p style="color: #666; margin-bottom: 10px; font-size: 14px;">
            å…± {{ reports|length }} æ¡æŠ¥è¡¨è®°å½•ï¼ˆä»…æ˜¾ç¤ºæœ€è¿‘20æ¡ï¼Œè¶…è¿‡30å¤©çš„æŠ¥è¡¨ä¼šè‡ªåŠ¨æ¸…ç†ï¼‰
        </p>
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>æŠ¥è¡¨ç±»å‹</th>
                        <th>æŠ¥è¡¨åç§°</th>
                        <th>ç»Ÿè®¡æ—¶é—´</th>
                        <th>æ€»é¢„çº¦æ¬¡æ•°</th>
                        <th>æ€»æ”¶å…¥ï¼ˆå…ƒï¼‰</th>
                        <th>ç”Ÿæˆæ—¶é—´</th>
                        <th>ç”Ÿæˆæ–¹å¼</th>
                        <th>ç”Ÿæˆäºº</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>{{ report.get_report_type_display }}</td>
                        <td>{{ report.report_name }}</td>
                        <td>{{ report.start_date|date:"Y-m-d" }} è‡³ {{ report.end_date|date:"Y-m-d" }}</td>
                        <td>{{ report.total_bookings }}</td>
                        <td>{{ report.total_revenue }}</td>
                        <td>{{ report.generated_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if report.generated_by %}
                                <span style="color: #3498db; font-weight: 500;">æ‰‹åŠ¨ç”Ÿæˆ</span>
                            {% else %}
                                <span style="color: #2ecc71; font-weight: 500;">ğŸ”„ è‡ªåŠ¨ç”Ÿæˆ</span>
                            {% endif %}
                        </td>
                        <td>{{ report.generated_by.username|default:"ç³»ç»Ÿè‡ªåŠ¨" }}</td>
                        <td style="min-width: 150px;">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <a href="?view={{ report.id }}" class="btn btn-info" style="white-space: nowrap; flex-shrink: 0;">æŸ¥çœ‹è¯¦æƒ…</a>
                                <a href="{% url 'manager_export_report_csv' report_id=report.id %}" class="btn btn-success" style="white-space: nowrap; flex-shrink: 0;">å¯¼å‡º</a>
                                <a href="{% url 'manager_delete_report' report_id=report.id %}" 
                                   class="btn btn-danger" 
                                   style="white-space: nowrap; flex-shrink: 0;"
                                   onclick="return confirm('ç¡®å®šè¦åˆ é™¤æŠ¥è¡¨ã€{{ report.report_name }}ã€‘å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')">åˆ é™¤</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: #666;">æš‚æ— å·²ç”Ÿæˆçš„æŠ¥è¡¨</p>
        {% endif %}
    </div>

    <!-- æŠ¥è¡¨è¯¦æƒ…å±•ç¤º -->
    {% if current_report %}
    <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin: 0; flex: 1; min-width: 200px;">{{ current_report.report_name }}</h3>
            <a href="{% url 'manager_export_report_csv' report_id=current_report.id %}" class="btn btn-success" style="white-space: nowrap; flex-shrink: 0;">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</a>
        </div>
        <p style="color: #666; margin-bottom: 20px;">
            ç»Ÿè®¡æ—¶é—´ï¼š{{ current_report.start_date|date:"Yå¹´mæœˆdæ—¥" }} è‡³ {{ current_report.end_date|date:"Yå¹´mæœˆdæ—¥" }} | 
            ç”Ÿæˆæ—¶é—´ï¼š{{ current_report.generated_at|date:"Y-m-d H:i" }}
        </p>
        
        {% with data=current_report.get_report_data %}
        <!-- æ±‡æ€»ç»Ÿè®¡ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #3498db;">{{ data.summary.total_bookings }}</div>
                <div style="color: #666;">æ€»é¢„çº¦æ¬¡æ•°</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">{{ data.summary.approved_count }}</div>
                <div style="color: #666;">å·²å®¡æ‰¹é€šè¿‡</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">{{ data.summary.total_revenue|floatformat:2 }}</div>
                <div style="color: #666;">æ€»æ”¶å…¥ï¼ˆå…ƒï¼‰</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">{{ data.summary.total_devices }}</div>
                <div style="color: #666;">è®¾å¤‡æ€»æ•°</div>
            </div>
        </div>

        <!-- è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡è¡¨ -->
        <h4 style="margin-top: 30px; margin-bottom: 15px;">è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>è®¾å¤‡ç¼–å·</th>
                        <th>è®¾å¤‡å‹å·</th>
                        <th>é¢„çº¦æ¬¡æ•°</th>
                        <th>ä½¿ç”¨æ—¶é•¿ï¼ˆå°æ—¶ï¼‰</th>
                        <th>ä½¿ç”¨ç‡ï¼ˆ%ï¼‰</th>
                        <th>æ ¡å¤–æ”¶è´¹ï¼ˆå…ƒï¼‰</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in data.device_usage %}
                    <tr>
                        <td>{{ device.device_code }}</td>
                        <td>{{ device.device_model }}</td>
                        <td>{{ device.booking_count }}</td>
                        <td>{{ device.usage_hours }}</td>
                        <td>{{ device.usage_rate }}%</td>
                        <td>{{ device.revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">æš‚æ— è®¾å¤‡ä½¿ç”¨æ•°æ®</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ç”¨æˆ·ç±»å‹ç»Ÿè®¡ -->
        <h4 style="margin-top: 30px; margin-bottom: 15px;">ç”¨æˆ·ç±»å‹ç»Ÿè®¡</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ç”¨æˆ·ç±»å‹</th>
                        <th>é¢„çº¦æ¬¡æ•°</th>
                        <th>ç”¨æˆ·æ•°é‡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in data.user_type_stats %}
                    <tr>
                        <td>
                            {% if stat.applicant__user_type == 'student' %}æ ¡å†…å­¦ç”Ÿ
                            {% elif stat.applicant__user_type == 'teacher' %}æ ¡å†…æ•™å¸ˆ
                            {% elif stat.applicant__user_type == 'external' %}æ ¡å¤–äººå‘˜
                            {% else %}{{ stat.applicant__user_type }}{% endif %}
                        </td>
                        <td>{{ stat.booking_count }}</td>
                        <td>{{ stat.user_count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">æš‚æ— ç”¨æˆ·ç±»å‹æ•°æ®</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endwith %}
    </div>
    {% endif %}
</div>

<script>
    // æ ¹æ®æŠ¥è¡¨ç±»å‹è‡ªåŠ¨è°ƒæ•´æ—¥æœŸè¾“å…¥æ ¼å¼
    document.getElementById('report_type_select').addEventListener('change', function() {
        const type = this.value;
        const dateInputDiv = document.getElementById('date_input_div');
        const startDateDiv = document.getElementById('start_date_div');
        const endDateDiv = document.getElementById('end_date_div');
        const dateInput = document.getElementById('date_input');
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        const dateHint = document.getElementById('date_hint');
        
        if (type === 'custom') {
            // è‡ªå®šä¹‰æ—¶é—´æ®µï¼šæ˜¾ç¤ºèµ·å§‹å’Œç»“æŸæ—¥æœŸè¾“å…¥æ¡†
            dateInputDiv.style.display = 'none';
            startDateDiv.style.display = 'block';
            endDateDiv.style.display = 'block';
            dateInput.required = false;
            startDate.required = true;
            endDate.required = true;
        } else {
            // å‘¨/æœˆ/å¹´æŠ¥è¡¨ï¼šæ˜¾ç¤ºæ—¥æœŸè¾“å…¥æ¡†
            dateInputDiv.style.display = 'block';
            startDateDiv.style.display = 'none';
            endDateDiv.style.display = 'none';
            dateInput.required = true;
            startDate.required = false;
            endDate.required = false;
            
            if (type === 'week') {
                dateInput.type = 'date';
                dateInput.placeholder = 'é€‰æ‹©æ—¥æœŸï¼ˆå¦‚ 2025-01-10ï¼‰';
                dateHint.innerHTML = 'å‘¨æŠ¥è¡¨ï¼šé€‰æ‹©æ—¥æœŸï¼ˆå¦‚ 2025-01-10ï¼‰';
            } else if (type === 'month') {
                dateInput.type = 'month';
                dateInput.placeholder = 'é€‰æ‹©æœˆä»½ï¼ˆå¦‚ 2025-01ï¼‰';
                dateHint.innerHTML = 'æœˆæŠ¥è¡¨ï¼šé€‰æ‹©æœˆä»½ï¼ˆå¦‚ 2025-01ï¼‰';
            } else if (type === 'year') {
                dateInput.type = 'text';
                dateInput.placeholder = 'è¾“å…¥å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰';
                dateInput.pattern = '[0-9]{4}';
                dateHint.innerHTML = 'å¹´æŠ¥è¡¨ï¼šè¾“å…¥å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰';
            }
        }
    });
    
    // è¡¨å•æäº¤éªŒè¯
    document.getElementById('report_form').addEventListener('submit', function(e) {
        const reportType = document.getElementById('report_type_select').value;
        if (reportType === 'custom') {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            if (!startDate || !endDate) {
                e.preventDefault();
                alert('è‡ªå®šä¹‰æ—¶é—´æ®µæŠ¥è¡¨éœ€è¦å¡«å†™èµ·å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸï¼');
                return false;
            }
            if (new Date(startDate) > new Date(endDate)) {
                e.preventDefault();
                alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸï¼');
                return false;
            }
        }
    });
</script>
{% endblock %}
