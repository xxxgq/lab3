{% extends 'base.html' %}

{% block title %}è´Ÿè´£äººæŠ¥è¡¨ç»Ÿè®¡ - æ±Ÿå—å¤§å­¦å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <a href="{% url 'manager_home' %}">é¦–é¡µ</a>
    <a href="{% url 'manager_booking_approve' %}">æ ¡å¤–äººå‘˜é¢„çº¦å®¡æ‰¹</a>
    <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
    <a href="{% url 'user_manage' %}">ç”¨æˆ·ç®¡ç†</a>
    <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
    <a href="{% url 'manager_report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>å®éªŒå®¤è´Ÿè´£äºº - è®¾å¤‡ä½¿ç”¨æŠ¥è¡¨ç»Ÿè®¡</h2>
    
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #3498db; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #2980b9;">ğŸ“… æŠ¥è¡¨ç³»ç»Ÿè¯´æ˜</h4>
        <p style="margin: 5px 0; color: #555; line-height: 1.6;">
            â€¢ <strong>ç³»ç»Ÿä¼šè‡ªåŠ¨ç”ŸæˆæŠ¥è¡¨</strong>ï¼š<br>
              <span style="margin-left: 20px;">- å‘¨æŠ¥è¡¨ï¼šæ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€å‘¨æŠ¥è¡¨</span><br>
              <span style="margin-left: 20px;">- æœˆæŠ¥è¡¨ï¼šæ¯æœˆ1å·å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€æœˆæŠ¥è¡¨</span><br>
              <span style="margin-left: 20px;">- å¹´æŠ¥è¡¨ï¼šæ¯å¹´1æœˆ1å·å‡Œæ™¨2ç‚¹ç”Ÿæˆä¸Šä¸€å¹´æŠ¥è¡¨</span><br>
            â€¢ <strong>æŠ¥è¡¨è‡ªåŠ¨æ¸…ç†</strong>ï¼šè¶…è¿‡30å¤©çš„æŠ¥è¡¨ä¼šè¢«è‡ªåŠ¨æ¸…ç†<br>
            â€¢ <strong>æ‰‹åŠ¨ç”Ÿæˆ</strong>ï¼šæ‚¨å¯ä»¥æ ¹æ®è´Ÿè´£äººæƒé™æ‰‹åŠ¨è¡¥å‘æŒ‡å®šæ—¶é—´æ®µçš„æŠ¥è¡¨
        </p>
    </div>
    
    <div style="margin-bottom: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
        <h3 style="margin-bottom: 15px;">ğŸ”§ æ‰‹åŠ¨ç”ŸæˆæŠ¥è¡¨</h3>
        <form method="post" id="report_form">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px;">æŠ¥è¡¨ç±»å‹ï¼š</label>
                    <select name="report_type" class="form-control" required style="width: 100%;" id="report_type_select">
                        <option value="week">å‘¨æŠ¥è¡¨</option>
                        <option value="month">æœˆæŠ¥è¡¨</option>
                        <option value="year">å¹´æŠ¥è¡¨</option>
                        <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µæŠ¥è¡¨</option>
                    </select>
                </div>
                <div id="date_input_div">
                    <label style="display: block; margin-bottom: 5px;">æ—¥æœŸï¼š</label>
                    <input type="text" name="date_input" class="form-control" placeholder="YYYY-MM-DD" style="width: 100%;" id="date_input">
                </div>
                <div id="start_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">èµ·å§‹æ—¥æœŸï¼š</label>
                    <input type="date" name="start_date" class="form-control" style="width: 100%;" id="start_date">
                </div>
                <div id="end_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" name="end_date" class="form-control" style="width: 100%;" id="end_date">
                </div>
            </div>
            <div>
                <button type="submit" name="generate" class="btn btn-primary">ç”ŸæˆæŠ¥è¡¨</button>
            </div>
        </form>
    </div>

    <div style="margin-bottom: 30px;">
        <h3>ğŸ“‹ å†å²æŠ¥è¡¨åˆ—è¡¨</h3>
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>æŠ¥è¡¨ç±»å‹</th>
                        <th>æŠ¥è¡¨åç§°</th>
                        <th>ç»Ÿè®¡æ—¶é—´</th>
                        <th>æ€»æ”¶å…¥ï¼ˆå…ƒï¼‰</th>
                        <th>ç”Ÿæˆæ–¹å¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>{{ report.get_report_type_display }}</td>
                        <td>{{ report.report_name }}</td>
                        <td>{{ report.start_date|date:"Y-m-d" }} è‡³ {{ report.end_date|date:"Y-m-d" }}</td>
                        <td>{{ report.total_revenue }}</td>
                        <td>{{ report.generated_by.username|default:"ç³»ç»Ÿè‡ªåŠ¨" }}</td>
                        <td style="min-width: 150px;">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <a href="?view={{ report.id }}" class="btn btn-info btn-sm" style="white-space: nowrap; flex-shrink: 0;">æŸ¥çœ‹è¯¦æƒ…</a>
                                <a href="{% url 'manager_export_report_csv' report_id=report.id %}" class="btn btn-success btn-sm" style="white-space: nowrap; flex-shrink: 0;">å¯¼å‡º</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <hr>

    {% if current_report %}
    <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin: 0; flex: 1; min-width: 200px;">{{ current_report.report_name }}ï¼ˆè´Ÿè´£äººè§†è§’ï¼‰</h3>
            <a href="{% url 'manager_export_report_csv' report_id=current_report.id %}" class="btn btn-success" style="white-space: nowrap; flex-shrink: 0;">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</a>
        </div>
        <p style="color: #666; margin-bottom: 20px;">
            ç»Ÿè®¡æ—¶é—´ï¼š{{ current_report.start_date|date:"Yå¹´mæœˆdæ—¥" }} è‡³ {{ current_report.end_date|date:"Yå¹´mæœˆdæ—¥" }} | 
            ç”Ÿæˆæ—¶é—´ï¼š{{ current_report.generated_at|date:"Y-m-d H:i" }}
        </p>
        
        <div style="display: flex; gap: 20px; margin: 20px 0;">
            <div style="flex: 1; height: 300px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <strong>ğŸ“ˆ è®¾å¤‡é‡‡è´­/æŠ¥åºŸè¶‹åŠ¿å›¾</strong>
            </div>
            <div style="flex: 1; height: 300px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <strong>ğŸ’° æ ¡å¤–æ”¶è´¹ç»Ÿè®¡é¥¼å›¾ï¼ˆï¿¥{{ current_report.total_revenue }}ï¼‰</strong>
            </div>
        </div>

        {% with data=current_report.get_report_data %}
        <table class="table" style="background: white;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th>è®¾å¤‡ç¼–å·</th>
                    <th>è®¾å¤‡å‹å·</th>
                    <th>æ€»é¢„çº¦æ¬¡æ•°</th>
                    <th>æ ¡å¤–æ”¶è´¹ï¼ˆå…ƒï¼‰</th>
                    <th>ä½¿ç”¨ç‡</th>
                    <th style="color: #e67e22;">è´Ÿè´£äººå†³ç­–ï¼šæ˜¯å¦éœ€é‡‡è´­è¡¥å……</th>
                </tr>
            </thead>
            <tbody>
                {% for device in data.device_usage %}
                <tr>
                    <td>{{ device.device_code }}</td>
                    <td>{{ device.device_model }}</td>
                    <td>{{ device.booking_count }}</td>
                    <td>{{ device.revenue }}</td>
                    <td>{{ device.usage_rate }}%</td>
                    <td>
                        {% if device.usage_rate > 80 %}
                            <span style="color: red; font-weight: bold;">æ˜¯ï¼ˆå»ºè®®å¢è´­ï¼‰</span>
                        {% else %}
                            <span style="color: #27ae60;">å¦</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endwith %}
    </div>
    {% endif %}
</div>

<script>
    // ä¿ç•™ä»–äººå¢åŠ çš„åŠ¨æ€è¡¨å•åˆ‡æ¢ JS é€»è¾‘
    document.getElementById('report_type_select').addEventListener('change', function() {
        const type = this.value;
        const dateInputDiv = document.getElementById('date_input_div');
        const startDateDiv = document.getElementById('start_date_div');
        const endDateDiv = document.getElementById('end_date_div');
        const dateInput = document.getElementById('date_input');
        
        if (type === 'custom') {
            dateInputDiv.style.display = 'none';
            startDateDiv.style.display = 'block';
            endDateDiv.style.display = 'block';
            dateInput.required = false;
        } else {
            dateInputDiv.style.display = 'block';
            startDateDiv.style.display = 'none';
            endDateDiv.style.display = 'none';
            dateInput.required = true;
            if (type === 'month') dateInput.placeholder = "YYYY-MM";
            else if (type === 'year') dateInput.placeholder = "YYYY";
            else dateInput.placeholder = "YYYY-MM-DD";
        }
    });
</script>
{% endblock %}