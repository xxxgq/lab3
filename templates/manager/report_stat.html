{% extends 'base.html' %}

{% block title %}负责人报表统计 - 江南大学实验室设备管理系统{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <a href="{% url 'manager_home' %}">首页</a>
    <a href="{% url 'manager_booking_approve' %}">校外人员预约审批</a>
    <a href="{% url 'user_manage' %}">用户管理</a>
    <a href="{% url 'ledger:ledger_home' %}">台账</a>
    <a href="{% url 'manager_report_stat' %}" class="active">报表统计</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>实验室负责人 - 设备使用报表统计</h2>
    
    <!-- 生成报表表单 -->
    <div style="margin-bottom: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
        <h3 style="margin-bottom: 15px;">生成新报表</h3>
        <form method="post" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            {% csrf_token %}
            <div>
                <label style="display: block; margin-bottom: 5px;">报表类型：</label>
                <select name="report_type" class="form-control" required style="width: 150px;">
                    <option value="week">周报表</option>
                    <option value="month">月报表</option>
                    <option value="year">年报表</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px;">日期：</label>
                <input type="text" name="date_input" class="form-control" required 
                       placeholder="周报表: YYYY-MM-DD, 月报表: YYYY-MM, 年报表: YYYY"
                       style="width: 250px;" id="date_input">
                <small style="color: #666; display: block; margin-top: 5px;">
                    周报表：选择日期（如 2025-01-10）<br>
                    月报表：选择月份（如 2025-01）<br>
                    年报表：输入年份（如 2025）
                </small>
            </div>
            <div>
                <button type="submit" name="generate" class="btn btn-primary">生成报表</button>
            </div>
        </form>
    </div>
    
    <!-- 已生成报表列表 -->
    <div style="margin-bottom: 30px;">
        <h3>已生成报表列表</h3>
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>报表类型</th>
                        <th>报表名称</th>
                        <th>统计时间</th>
                        <th>总预约次数</th>
                        <th>总收入（元）</th>
                        <th>生成时间</th>
                        <th>生成人</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>{{ report.get_report_type_display }}</td>
                        <td>{{ report.report_name }}</td>
                        <td>{{ report.start_date|date:"Y-m-d" }} 至 {{ report.end_date|date:"Y-m-d" }}</td>
                        <td>{{ report.total_bookings }}</td>
                        <td>{{ report.total_revenue }}</td>
                        <td>{{ report.generated_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ report.generated_by.username|default:"系统" }}</td>
                        <td>
                            <a href="?view={{ report.id }}" class="btn btn-info" style="white-space: nowrap;">查看详情</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: #666;">暂无已生成的报表</p>
        {% endif %}
    </div>

    <!-- 报表详情展示 -->
    {% if current_report %}
    <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
        <h3>{{ current_report.report_name }}</h3>
        <p style="color: #666; margin-bottom: 20px;">
            统计时间：{{ current_report.start_date|date:"Y年m月d日" }} 至 {{ current_report.end_date|date:"Y年m月d日" }} | 
            生成时间：{{ current_report.generated_at|date:"Y-m-d H:i" }}
        </p>
        
        {% with data=current_report.get_report_data %}
        <!-- 汇总统计 -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #3498db;">{{ data.summary.total_bookings }}</div>
                <div style="color: #666;">总预约次数</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">{{ data.summary.approved_count }}</div>
                <div style="color: #666;">已审批通过</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">{{ data.summary.total_revenue|floatformat:2 }}</div>
                <div style="color: #666;">总收入（元）</div>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">{{ data.summary.total_devices }}</div>
                <div style="color: #666;">设备总数</div>
            </div>
        </div>

        <!-- 设备使用统计表 -->
        <h4 style="margin-top: 30px; margin-bottom: 15px;">设备使用统计</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>设备编号</th>
                        <th>设备型号</th>
                        <th>预约次数</th>
                        <th>使用时长（小时）</th>
                        <th>使用率（%）</th>
                        <th>校外收费（元）</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in data.device_usage %}
                    <tr>
                        <td>{{ device.device_code }}</td>
                        <td>{{ device.device_model }}</td>
                        <td>{{ device.booking_count }}</td>
                        <td>{{ device.usage_hours }}</td>
                        <td>{{ device.usage_rate }}%</td>
                        <td>{{ device.revenue|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">暂无设备使用数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 用户类型统计 -->
        <h4 style="margin-top: 30px; margin-bottom: 15px;">用户类型统计</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>用户类型</th>
                        <th>预约次数</th>
                        <th>用户数量</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in data.user_type_stats %}
                    <tr>
                        <td>
                            {% if stat.applicant__user_type == 'student' %}校内学生
                            {% elif stat.applicant__user_type == 'teacher' %}校内教师
                            {% elif stat.applicant__user_type == 'external' %}校外人员
                            {% else %}{{ stat.applicant__user_type }}{% endif %}
                        </td>
                        <td>{{ stat.booking_count }}</td>
                        <td>{{ stat.user_count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">暂无用户类型数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endwith %}
    </div>
    {% endif %}
</div>

<script>
    // 根据报表类型自动调整日期输入格式
    document.querySelector('select[name="report_type"]').addEventListener('change', function() {
        const dateInput = document.getElementById('date_input');
        const type = this.value;
        
        if (type === 'week') {
            dateInput.type = 'date';
            dateInput.placeholder = '选择日期（如 2025-01-10）';
        } else if (type === 'month') {
            dateInput.type = 'month';
            dateInput.placeholder = '选择月份（如 2025-01）';
        } else if (type === 'year') {
            dateInput.type = 'text';
            dateInput.placeholder = '输入年份（如 2025）';
            dateInput.pattern = '[0-9]{4}';
        }
    });
</script>
{% endblock %}
