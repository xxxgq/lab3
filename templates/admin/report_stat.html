{% extends 'base.html' %}

{% block title %}æŠ¥è¡¨ç»Ÿè®¡ - æ±Ÿå—å¤§å­¦å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<div class="sidebar">
    {% if is_admin %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a>
        <a href="{% url 'booking_approve' %}">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% elif is_manager %}
        <a href="{% url 'manager_home' %}">é¦–é¡µ</a>
        <a href="{% url 'manager_booking_approve' %}">æ ¡å¤–äººå‘˜é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'user_manage' %}">ç”¨æˆ·ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'manager_report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% else %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a>
        <a href="{% url 'booking_approve' %}">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>è®¾å¤‡ä½¿ç”¨æŠ¥è¡¨ç»Ÿè®¡</h2>
    
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #3498db; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #2980b9;">ğŸ“… æŠ¥è¡¨ç³»ç»Ÿè¯´æ˜</h4>
        <p style="margin: 5px 0; color: #555; line-height: 1.6; font-size: 14px;">
            â€¢ <strong>ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</strong>ï¼šå‘¨æŠ¥è¡¨ï¼ˆå‘¨ä¸€å‡Œæ™¨ï¼‰ã€æœˆæŠ¥è¡¨ï¼ˆæ¯æœˆ1å·ï¼‰ã€å¹´æŠ¥è¡¨ï¼ˆ1æœˆ1å·ï¼‰å®šæ—¶ç”Ÿæˆã€‚<br>
            â€¢ <strong>æ‰‹åŠ¨å³æ—¶ç”Ÿæˆ</strong>ï¼šæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ï¼Œæ‰‹åŠ¨ç”ŸæˆæŒ‡å®šæ—¥æœŸæˆ–â€œè‡ªå®šä¹‰æ—¶é—´æ®µâ€çš„ç»Ÿè®¡æŠ¥è¡¨ã€‚<br>
            â€¢ <strong>æŠ¥è¡¨æ¸…ç†</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†è¶…è¿‡30å¤©çš„å†å²æŠ¥è¡¨ã€‚
        </p>
    </div>

    <div style="margin-bottom: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
        <h3 style="margin-bottom: 15px;">ğŸ”§ ç”Ÿæˆä¸æ“ä½œ</h3>
        <form method="post" id="report_form">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 5px;">æŠ¥è¡¨ç±»å‹ï¼š</label>
                    <select name="report_type" id="report_type_select" class="form-control" style="width: 100%;">
                        <option value="week">å‘¨æŠ¥è¡¨</option>
                        <option value="month" selected>æœˆæŠ¥è¡¨</option>
                        <option value="year">å¹´æŠ¥è¡¨</option>
                        <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µ</option>
                    </select>
                </div>
                <div id="date_input_div">
                    <label style="display: block; margin-bottom: 5px;">ç»Ÿè®¡æ—¥æœŸ/æœˆä»½ï¼š</label>
                    <input type="month" name="date_input" id="date_input" class="form-control" style="width: 100%;" value="2025-12">
                </div>
                <div id="start_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">èµ·å§‹æ—¥æœŸï¼š</label>
                    <input type="date" name="start_date" id="start_date" class="form-control" style="width: 100%;">
                </div>
                <div id="end_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" name="end_date" id="end_date" class="form-control" style="width: 100%;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="generate" class="btn btn-primary">ç”ŸæˆæŠ¥è¡¨</button>
                    <button type="button" class="btn">æ‰“å°</button>
                </div>
            </div>
            <small style="color: #666; display: block; margin-top: 8px;" id="date_hint">æœˆæŠ¥è¡¨è¯·é€‰æ‹©å¯¹åº”æœˆä»½</small>
        </form>
    </div>

    <div style="margin-bottom: 30px;">
        <h3>ğŸ“‹ å†å²æŠ¥è¡¨è®°å½•</h3>
        {% if reports %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead>
                    <tr style="background-color: #34495e; color: white;">
                        <th style="padding: 10px; border: 1px solid #ddd;">ç±»å‹</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">åç§°</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">ç»Ÿè®¡å‘¨æœŸ</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">é¢„çº¦æ€»æ•°</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">ç”Ÿæˆäºº/æ–¹å¼</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ report.get_report_type_display }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ report.report_name }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ report.start_date|date:"Y-m-d" }} ~ {{ report.end_date|date:"Y-m-d" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{{ report.total_bookings }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            {% if report.generated_by %}
                                {{ report.generated_by.username }} (æ‰‹åŠ¨)
                            {% else %}
                                <span style="color: #2ecc71;">ğŸ”„ ç³»ç»Ÿè‡ªåŠ¨</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <a href="?view={{ report.id }}" class="btn btn-info" style="padding: 2px 8px; font-size: 12px; white-space: nowrap;">æŸ¥çœ‹è¯¦æƒ…</a>
                                <a href="{% url 'export_report_csv' report_id=report.id %}" class="btn btn-success" style="padding: 2px 8px; font-size: 12px; white-space: nowrap;">å¯¼å‡º</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æŠ¥è¡¨è®°å½•ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆã€‚</p>
        {% endif %}
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

    {% if current_report %}
    <div style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
            <h3 style="margin: 0; color: #2c3e50;">{{ current_report.report_name }} è¯¦æƒ…</h3>
            <a href="{% url 'export_report_csv' report_id=current_report.id %}" class="btn btn-success" style="white-space: nowrap;">ğŸ“¥ å¯¼å‡ºæ­¤æŠ¥è¡¨</a>
        </div>
        <p style="color: #666; margin-bottom: 20px;">
            ç»Ÿè®¡æ—¶é—´ï¼š{{ current_report.start_date|date:"Yå¹´mæœˆdæ—¥" }} è‡³ {{ current_report.end_date|date:"Yå¹´mæœˆdæ—¥" }} | 
            ç”Ÿæˆæ—¶é—´ï¼š{{ current_report.generated_at|date:"Y-m-d H:i" }}
        </p>
        
        {% with data=current_report.get_report_data %}
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">æ€»é¢„çº¦æ¬¡æ•°</div>
                <div style="font-size: 24px; font-weight: bold; color: #3498db;">{{ data.summary.total_bookings }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">å·²é€šè¿‡å®¡æ‰¹</div>
                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">{{ data.summary.approved_count }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">ç»Ÿè®¡è®¾å¤‡æ•°</div>
                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">{{ data.summary.total_devices }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">æ ¡å¤–æ€»æ”¶å…¥</div>
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">ï¿¥{{ data.summary.total_revenue|floatformat:2 }}</div>
            </div>
        </div>

        <div style="display: flex; gap: 20px; margin: 25px 0;">
            <div style="flex: 1; height: 260px; background-color: #fcfcfc; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; color: #999;">
                [å›¾è¡¨] è®¾å¤‡ä½¿ç”¨ç‡èµ°åŠ¿ (åŸºäºæ•°æ®æ¸²æŸ“)
            </div>
            <div style="flex: 1; height: 260px; background-color: #fcfcfc; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; color: #999;">
                [å›¾è¡¨] ç”¨æˆ·ç±»å‹åˆ†å¸ƒå æ¯” (åŸºäºæ•°æ®æ¸²æŸ“)
            </div>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 10px; border: 1px solid #ddd;">è®¾å¤‡ç¼–å·</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">å‹å·</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">é¢„çº¦æ¬¡æ•°</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ä½¿ç”¨æ—¶é•¿(h)</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">ä½¿ç”¨ç‡</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">æ ¡å¤–æ”¶è´¹(å…ƒ)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data.device_usage %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ item.device_code }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ item.device_model }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{{ item.booking_count }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{{ item.usage_hours }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{{ item.usage_rate }}%</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">{{ item.revenue|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endwith %}
    </div>
    {% else %}
    <div style="text-align: center; color: #999; padding: 40px;">
        <p>è¯·ä»ä¸Šæ–¹åˆ—è¡¨ä¸­é€‰æ‹©æŠ¥è¡¨æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–å¡«å†™æ—¥æœŸç”Ÿæˆæ–°æŠ¥è¡¨ã€‚</p>
    </div>
    {% endif %}

    <script>
        document.getElementById('report_type_select').addEventListener('change', function() {
            const type = this.value;
            const dateDiv = document.getElementById('date_input_div');
            const startDiv = document.getElementById('start_date_div');
            const endDiv = document.getElementById('end_date_div');
            const hint = document.getElementById('date_hint');
            const dateInput = document.getElementById('date_input');

            if (type === 'custom') {
                dateDiv.style.display = 'none';
                startDiv.style.display = 'block';
                endDiv.style.display = 'block';
                hint.innerText = 'è¯·é€‰æ‹©è‡ªå®šä¹‰æ—¶é—´æ®µçš„èµ·æ­¢æ—¥æœŸ';
            } else {
                dateDiv.style.display = 'block';
                startDiv.style.display = 'none';
                endDiv.style.display = 'none';
                if (type === 'week') {
                    dateInput.type = 'date';
                    hint.innerText = 'è¯·é€‰æ‹©è¯¥å‘¨å†…çš„ä»»æ„ä¸€å¤©';
                } else if (type === 'month') {
                    dateInput.type = 'month';
                    hint.innerText = 'è¯·é€‰æ‹©ç»Ÿè®¡æœˆä»½';
                } else if (type === 'year') {
                    dateInput.type = 'number';
                    dateInput.placeholder = 'YYYY';
                    hint.innerText = 'è¯·è¾“å…¥ç»Ÿè®¡å¹´ä»½ï¼ˆå¦‚2026ï¼‰';
                }
            }
        });
    </script>
</div>
{% endblock %}