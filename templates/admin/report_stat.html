{% extends 'base.html' %}

{% block title %}æŠ¥è¡¨ç»Ÿè®¡ - æ±Ÿå—å¤§å­¦å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<div class="sidebar">
    {% if is_admin %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a>
        <a href="{% url 'booking_approve' %}">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% elif is_manager %}
        <a href="{% url 'manager_home' %}">é¦–é¡µ</a>
        <a href="{% url 'manager_booking_approve' %}">æ ¡å¤–äººå‘˜é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'user_manage' %}">ç”¨æˆ·ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'manager_report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% else %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a>
        <a href="{% url 'booking_approve' %}">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}" class="active">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>è®¾å¤‡ä½¿ç”¨æŠ¥è¡¨ç»Ÿè®¡</h2>
    
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-left: 4px solid #3498db; border-radius: 4px;">
        <h4 style="margin-top: 0; color: #2980b9;">ğŸ“… æŠ¥è¡¨ç³»ç»Ÿè¯´æ˜</h4>
        <p style="margin: 5px 0; color: #555; line-height: 1.6; font-size: 14px;">
            â€¢ <strong>ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ</strong>ï¼šå‘¨æŠ¥è¡¨ï¼ˆå‘¨ä¸€å‡Œæ™¨ï¼‰ã€æœˆæŠ¥è¡¨ï¼ˆæ¯æœˆ1å·ï¼‰ã€å¹´æŠ¥è¡¨ï¼ˆ1æœˆ1å·ï¼‰å®šæ—¶ç”Ÿæˆã€‚<br>
            â€¢ <strong>æ‰‹åŠ¨å³æ—¶ç”Ÿæˆ</strong>ï¼šæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ï¼Œæ‰‹åŠ¨è¡¥å‘æŒ‡å®šæ—¥æœŸæˆ–â€œè‡ªå®šä¹‰æ—¶é—´æ®µâ€çš„ç»Ÿè®¡æŠ¥è¡¨ã€‚<br>
            â€¢ <strong>æŠ¥è¡¨æ¸…ç†</strong>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†è¶…è¿‡30å¤©çš„å†å²æŠ¥è¡¨è®°å½•ã€‚
        </p>
    </div>

    <div style="margin-bottom: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
        <h3 style="margin-bottom: 15px;">ğŸ”§ æ‰‹åŠ¨ç”ŸæˆæŠ¥è¡¨</h3>
        <form method="post" id="report_form">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 5px;">æŠ¥è¡¨ç±»å‹ï¼š</label>
                    <select name="report_type" id="report_type_select" class="form-control" style="width: 100%;">
                        <option value="week">å‘¨æŠ¥è¡¨</option>
                        <option value="month" selected>æœˆæŠ¥è¡¨</option>
                        <option value="year">å¹´æŠ¥è¡¨</option>
                        <option value="custom">è‡ªå®šä¹‰æ—¶é—´æ®µ</option>
                    </select>
                </div>
                <div id="date_input_div">
                    <label style="display: block; margin-bottom: 5px;">ç»Ÿè®¡æ—¥æœŸ/æœˆä»½ï¼š</label>
                    <input type="month" name="date_input" id="date_input" class="form-control" style="width: 100%;">
                </div>
                <div id="start_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">èµ·å§‹æ—¥æœŸï¼š</label>
                    <input type="date" name="start_date" id="start_date" class="form-control">
                </div>
                <div id="end_date_div" style="display: none;">
                    <label style="display: block; margin-bottom: 5px;">ç»“æŸæ—¥æœŸï¼š</label>
                    <input type="date" name="end_date" id="end_date" class="form-control">
                </div>
                <div>
                    <button type="submit" name="generate" class="btn btn-primary">ç”ŸæˆæŠ¥è¡¨</button>
                </div>
            </div>
            <small style="color: #666; display: block; margin-top: 8px;" id="date_hint">æœˆæŠ¥è¡¨è¯·é€‰æ‹©å¯¹åº”æœˆä»½</small>
        </form>
    </div>

    <div style="margin-bottom: 30px;">
        <h3>ğŸ“‹ å†å²æŠ¥è¡¨è®°å½•</h3>
        {% if reports %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ç±»å‹</th>
                        <th>åç§°</th>
                        <th>ç»Ÿè®¡æ—¶é—´</th>
                        <th>é¢„çº¦æ€»æ•°</th>
                        <th>æ€»æ”¶å…¥ï¼ˆå…ƒï¼‰</th>
                        <th>ç”Ÿæˆæ–¹å¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr>
                        <td>{{ report.get_report_type_display }}</td>
                        <td>{{ report.report_name }}</td>
                        <td>{{ report.start_date|date:"Y-m-d" }} è‡³ {{ report.end_date|date:"Y-m-d" }}</td>
                        <td>{{ report.total_bookings }}</td>
                        <td>{{ report.total_revenue }}</td>
                        <td>
                            {% if report.generated_by %}
                                <span style="color: #3498db;">æ‰‹åŠ¨ ({{ report.generated_by.username }})</span>
                            {% else %}
                                <span style="color: #2ecc71;">ğŸ”„ è‡ªåŠ¨ç”Ÿæˆ</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <a href="?view={{ report.id }}" class="btn btn-info btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                                <a href="{% url 'export_report_csv' report_id=report.id %}" class="btn btn-success btn-sm">å¯¼å‡º</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: #999; text-align: center; padding: 20px;">æš‚æ— æŠ¥è¡¨è®°å½•ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆã€‚</p>
        {% endif %}
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

    {% if current_report %}
    <div id="report_detail">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #2c3e50;">{{ current_report.report_name }} è¯¦æƒ…</h3>
            <a href="{% url 'export_report_csv' report_id=current_report.id %}" class="btn btn-success">ğŸ“¥ å¯¼å‡º Excel æŠ¥è¡¨</a>
        </div>
        
        {% with data=current_report.get_report_data %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">æ€»é¢„çº¦æ¬¡æ•°</div>
                <div style="font-size: 24px; font-weight: bold; color: #3498db;">{{ data.summary.total_bookings }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">å·²é€šè¿‡å®¡æ‰¹ (æœ€ç»ˆé€šè¿‡)</div>
                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">{{ data.summary.approved_count }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">å¾…å¤„ç† (å«æŒ‡å¯¼æ•™å¸ˆ/ç®¡ç†å‘˜)</div>
                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">{{ data.summary.pending_count }}</div>
            </div>
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
                <div style="color: #7f8c8d; font-size: 12px;">æ ¡å¤–æ€»æ”¶å…¥</div>
                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">ï¿¥{{ data.summary.total_revenue|floatformat:2 }}</div>
            </div>
        </div>

        <h4 style="margin-top: 30px; margin-bottom: 15px;">ğŸ‘¥ ç”¨æˆ·ç±»å‹åˆ†å¸ƒç»Ÿè®¡</h4>
        <div class="table-responsive" style="margin-bottom: 30px;">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ç”¨æˆ·ç±»å‹</th>
                        <th>é¢„çº¦æ¬¡æ•° (é€šè¿‡)</th>
                        <th>è¦†ç›–ç”¨æˆ·æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in data.user_type_stats %}
                    <tr>
                        <td>
                            {% if stat.applicant__user_type == 'student' %}æ ¡å†…å­¦ç”Ÿ
                            {% elif stat.applicant__user_type == 'teacher' %}æ ¡å†…æ•™å¸ˆ
                            {% elif stat.applicant__user_type == 'external' %}æ ¡å¤–äººå‘˜
                            {% else %}{{ stat.applicant__user_type }}{% endif %}
                        </td>
                        <td>{{ stat.booking_count }}</td>
                        <td>{{ stat.user_count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-center">æš‚æ— æ•°æ®</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h4 style="margin-top: 30px; margin-bottom: 15px;">ğŸ”§ è®¾å¤‡ä½¿ç”¨æ•ˆç‡æ˜ç»†</h4>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th>è®¾å¤‡ç¼–å·</th>
                        <th>å‹å·</th>
                        <th>é¢„çº¦æ¬¡æ•°</th>
                        <th>ä½¿ç”¨æ—¶é•¿(h)</th>
                        <th>ä½¿ç”¨ç‡</th>
                        <th>æ”¶å…¥é¢(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.device_usage %}
                    <tr>
                        <td>{{ item.device_code }}</td>
                        <td>{{ item.device_model }}</td>
                        <td>{{ item.booking_count }}</td>
                        <td>{{ item.usage_hours }}</td>
                        <td>{{ item.usage_rate }}%</td>
                        <td>{{ item.revenue|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endwith %}
    </div>
    {% else %}
    <div style="text-align: center; color: #999; padding: 40px;">
        <p>è¯·ä»ä¸Šæ–¹åˆ—è¡¨ä¸­é€‰æ‹©æŠ¥è¡¨æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–å¡«å†™æ—¥æœŸç”Ÿæˆæ–°æŠ¥è¡¨ã€‚</p>
    </div>
    {% endif %}

    <script>
        // ä¿®å¤4ï¼šå®Œå–„æ—¥æœŸè¾“å…¥æ¡†çš„åˆ‡æ¢é€»è¾‘
        document.getElementById('report_type_select').addEventListener('change', function() {
            const type = this.value;
            const dateDiv = document.getElementById('date_input_div');
            const startDiv = document.getElementById('start_date_div');
            const endDiv = document.getElementById('end_date_div');
            const hint = document.getElementById('date_hint');
            const dateInput = document.getElementById('date_input');

            if (type === 'custom') {
                dateDiv.style.display = 'none';
                startDiv.style.display = 'block';
                endDiv.style.display = 'block';
                hint.innerText = 'è¯·é€‰æ‹©è‡ªå®šä¹‰æ—¶é—´æ®µçš„èµ·æ­¢æ—¥æœŸ';
                dateInput.required = false;
            } else {
                dateDiv.style.display = 'block';
                startDiv.style.display = 'none';
                endDiv.style.display = 'none';
                dateInput.required = true;
                if (type === 'week') {
                    dateInput.type = 'date';
                    hint.innerText = 'è¯·é€‰æ‹©è¯¥å‘¨å†…çš„ä»»æ„ä¸€å¤©ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å…¨å‘¨';
                } else if (type === 'month') {
                    dateInput.type = 'month';
                    hint.innerText = 'è¯·é€‰æ‹©éœ€è¦ç»Ÿè®¡çš„æœˆä»½';
                } else if (type === 'year') {
                    dateInput.type = 'number';
                    dateInput.placeholder = 'YYYY';
                    hint.innerText = 'è¯·è¾“å…¥å››ä½ç»Ÿè®¡å¹´ä»½ï¼ˆå¦‚ 2025ï¼‰';
                }
            }
        });

        // æäº¤å‰æ ¡éªŒè‡ªå®šä¹‰æ—¥æœŸ
        document.getElementById('report_form').addEventListener('submit', function(e) {
            const type = document.getElementById('report_type_select').value;
            if (type === 'custom') {
                const s = document.getElementById('start_date').value;
                const o = document.getElementById('end_date').value;
                if (!s || !o) {
                    e.preventDefault();
                    alert('è‡ªå®šä¹‰æŠ¥è¡¨å¿…é¡»é€‰æ‹©èµ·æ­¢æ—¥æœŸï¼');
                }
            }
        });
    </script>
</div>
{% endblock %}