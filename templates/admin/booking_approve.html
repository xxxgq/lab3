{% extends 'base.html' %}

{% block title %}é¢„çº¦å®¡æ‰¹ - æ±Ÿå—å¤§å­¦å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block sidebar %}
<div class="sidebar">
    {% if is_admin %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a> 
        <a href="{% url 'booking_approve' %}" class="active">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% elif is_manager %}
        <a href="{% url 'manager_home' %}">é¦–é¡µ</a>
        <a href="{% url 'manager_booking_approve' %}" class="active">æ ¡å¤–äººå‘˜é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'user_manage' %}">ç”¨æˆ·ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'manager_report_stat' %}">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% else %}
        <a href="{% url 'admin_home' %}">é¦–é¡µ</a> 
        <a href="{% url 'booking_approve' %}" class="active">é¢„çº¦å®¡æ‰¹</a>
        <a href="{% url 'device_manage' %}">è®¾å¤‡ç®¡ç†</a>
        <a href="{% url 'ledger:ledger_home' %}">å°è´¦</a>
        <a href="{% url 'report_stat' %}">æŠ¥è¡¨ç»Ÿè®¡</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>è®¾å¤‡é¢„çº¦ç”³è¯·å®¡æ‰¹</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 10px; margin: 15px 0; border-radius: 4px; 
                {% if message.tags == 'success' %}background-color: #d4edda; color: #155724;{% endif %}
                {% if message.tags == 'error' %}background-color: #f8d7da; color: #721c24;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if is_admin %}
    <div style="margin-bottom: 20px;">
        <a href="{% url 'booking_approve' %}?user_type=all" class="btn {% if user_type_filter == 'all' or not user_type_filter %}btn-primary{% else %}btn-secondary{% endif %}">å…¨éƒ¨å¾…å®¡æ‰¹</a>
        <a href="{% url 'booking_approve' %}?user_type=teacher" class="btn {% if user_type_filter == 'teacher' %}btn-primary{% else %}btn-secondary{% endif %}">æ ¡å†…æ•™å¸ˆç”³è¯·</a>
        <a href="{% url 'booking_approve' %}?user_type=student" class="btn {% if user_type_filter == 'student' %}btn-primary{% else %}btn-secondary{% endif %}">æ ¡å†…å­¦ç”Ÿç”³è¯·</a>
        <a href="{% url 'booking_approve' %}?user_type=external" class="btn {% if user_type_filter == 'external' %}btn-primary{% else %}btn-secondary{% endif %}">æ ¡å¤–äººå‘˜ç”³è¯·</a>
    </div>
    {% elif is_manager %}
    <div style="margin-bottom: 20px; padding: 10px; background-color: #e9ecef; border-left: 5px solid #17a2b8;">
        <strong>ğŸ’¡ æç¤ºï¼š</strong> æ‚¨å½“å‰æ­£åœ¨å®¡æ ¸ç”±ç®¡ç†å‘˜åˆå®¡é€šè¿‡çš„ <strong>æ ¡å¤–äººå‘˜</strong> é¢„çº¦ç”³è¯·ã€‚
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="user_type_filter" value="{{ user_type_filter }}">
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 8px; border: 1px solid #dee2e6;">é€‰æ‹©</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">é¢„çº¦ç¼–å·</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">ç”³è¯·äºº</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">ç”¨æˆ·ç±»å‹</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">è®¾å¤‡ç¼–å·</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">é¢„çº¦æ—¶æ®µ</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">è®¾å¤‡çŠ¶æ€</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">å½“å‰çŠ¶æ€</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6;">å®¡æ‰¹å¤‡æ³¨</th> 
                    <th style="padding: 8px; border: 1px solid #dee2e6;">å®¡æ‰¹æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <input type="checkbox" name="booking_ids" value="{{ booking.id }}">
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.booking_code }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.applicant.name }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        {{ booking.applicant.get_user_type_display }}
                    </td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.device.device_code }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.booking_date }} {{ booking.time_slot }}</td>
                    
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.device.get_status_display }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ booking.get_status_display }}</td>

                    <td style="padding: 8px; border: 1px solid #dee2e6;">
                        <input type="text" name="comment_{{ booking.booking_code }}" placeholder="è¾“å…¥æ„è§" style="width: 100%; padding: 4px;">
                    </td>

                    <td style="padding: 8px; border: 1px solid #dee2e6; white-space: nowrap;">
                        {% if is_admin %}
                            <button type="submit" name="approve" value="{{ booking.id }}" class="btn btn-success btn-sm">æ‰¹å‡†</button>
                            <button type="submit" name="reject" value="{{ booking.id }}" class="btn btn-danger btn-sm">æ‹’ç»</button>
                        {% elif is_manager %}
                            <button type="submit" name="approve" value="{{ booking.id }}" class="btn btn-success btn-sm">æœ€ç»ˆæ‰¹å‡†</button>
                            <button type="submit" name="reject" value="{{ booking.id }}" class="btn btn-danger btn-sm">æ‹’ç»</button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">æš‚æ— å¾…å®¡æ‰¹çš„ç”³è¯·</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if bookings %}
        <div style="margin-top: 20px;">
            <button type="submit" name="batch_approve" class="btn btn-success">æ‰¹é‡æ‰¹å‡†</button>
            <button type="submit" name="batch_reject" class="btn btn-danger" style="margin-left: 10px;">æ‰¹é‡æ‹’ç»</button>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}