{% extends 'base.html' %}

{% block title %}个人信息 - 江南大学实验室设备管理系统{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <a href="{% url 'user_home' %}">首页</a>
    <a href="{% url 'device_list' %}">设备查询</a>
    <a href="{% url 'booking_apply' %}">预约申请</a>
    <a href="{% url 'my_booking' %}">我的预约</a>
    <a href="{% url 'user_profile' %}">个人信息</a>
    {% if is_teacher %}
    <a href="{% url 'teacher_booking_approve' %}">审批我的学生</a>
    <a href="{% url 'teacher_all_student_bookings' %}">查看我的学生申请</a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>个人信息管理</h2>
    <!-- 错误/成功提示 -->
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 10px; margin: 15px 0; border-radius: 4px; 
                {% if message.tags == 'success' %}background-color: #d4edda; color: #155724;{% endif %}
                {% if message.tags == 'error' %}background-color: #f8d7da; color: #721c24;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <div style="display: flex; gap: 40px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">用户类型</label>
                    <select name="user_type" disabled style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="student" {% if user_info.user_type == 'student' %}selected{% endif %}>校内学生</option>
                        <option value="teacher" {% if user_info.user_type == 'teacher' %}selected{% endif %}>校内教师</option>
                        <option value="external" {% if user_info.user_type == 'external' or user_info.user_type == 'outside' %}selected{% endif %}>校外人员</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">用户编号/学号/工号</label>
                    <input type="text" value="{{ user_info.user_code }}" readonly 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background-color: #e9ecef; cursor: not-allowed;"
                           title="用户编号不可修改">
                    <small style="color: #666; font-size: 12px;">用户编号唯一且不可修改</small>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">姓名</label>
                    <input type="text" name="name" value="{{ user_info.name }}" required 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                           placeholder="请输入姓名">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">性别</label>
                    <select name="gender" required style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="男" {% if user_info.gender == '男' %}selected{% endif %}>男</option>
                        <option value="女" {% if user_info.gender == '女' %}selected{% endif %}>女</option>
                    </select>
                </div>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">所在学院/单位</label>
                    <input type="text" name="department" value="{{ user_info.department }}" required 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                           placeholder="请输入学院/单位名称">
                </div>
                <!-- 【动态显示】不同用户类型显示不同字段 -->
                {% if user_info.user_type == 'student' %}
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">专业</label>
                        <input type="text" name="major" value="{{ user_info.major|default:'' }}" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                               placeholder="请输入专业名称">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">指导教师</label>
                        <div style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background-color: #f8f9fa; min-height: 40px;">
                            {% if user_info.advisors.all %}
                                {% for advisor in user_info.advisors.all %}
                                    <span style="display: inline-block; padding: 4px 8px; margin: 2px; background-color: #e9ecef; border-radius: 3px;">
                                        {{ advisor.name }}（{{ advisor.user_code }}）
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span style="color: #999;">暂无指导教师，请联系教师将您添加到学生列表</span>
                            {% endif %}
                        </div>
                        <small style="color: #666; font-size: 12px;">指导教师由教师管理，学生无法自行修改</small>
                    </div>
                {% elif user_info.user_type == 'teacher' %}
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">职称</label>
                        <input type="text" name="title" value="{{ user_info.title|default:'' }}" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                               placeholder="请输入职称（如教授/副教授）">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">研究方向</label>
                        <input type="text" name="research_field" value="{{ user_info.research_field|default:'' }}" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                               placeholder="请输入研究方向">
                    </div>
                {% elif user_info.user_type == 'external' %}
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">职务</label>
                        <input type="text" name="position" value="{{ user_info.position|default:'' }}" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                               placeholder="请输入职务">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">单位地址</label>
                        <input type="text" name="company_address" value="{{ user_info.company_address|default:'' }}" required 
                               style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                               placeholder="请输入单位详细地址">
                    </div>
                {% endif %}
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">联系电话</label>
                    <input type="tel" name="phone" value="{{ user_info.phone }}" required 
                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"
                           placeholder="请输入联系电话">
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-success" style="padding: 8px 20px;">保存修改</button>
        <!-- 跳转到修改密码页面 -->
        <button type="button" class="btn btn-secondary" style="margin-left: 10px; padding: 8px 20px;" 
                onclick="window.location.href='{% url 'change_password' %}'">修改密码</button>
    </form>
    
    <!-- 【动态显示】教师用户专属：指导学生列表 -->
    {% if user_info.user_type == 'teacher' %}
    <div style="margin-top: 40px;" id="teacher_student_list">
        <h3 style="margin-bottom: 10px;">指导学生列表管理</h3>
        
        <!-- 操作按钮 -->
        <div style="margin-bottom: 15px;">
            <a href="{% url 'add_student' %}" class="btn btn-primary" style="padding: 8px 20px; margin-right: 10px;">
                添加学生
            </a>
            <a href="{% url 'import_students_excel' %}" class="btn btn-secondary" style="padding: 8px 20px; margin-right: 10px;">批量导入（Excel）</a>
            <a href="{% url 'teacher_booking_approve' %}" class="btn btn-success" style="padding: 8px 20px; margin-right: 10px;">
                审批我的学生
            </a>
            <a href="{% url 'teacher_all_student_bookings' %}" class="btn" style="padding: 8px 20px;">
                查看我的学生申请
            </a>
        </div>
        
        <!-- 学生列表 -->
        <table style="margin-top: 10px; width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f8f9fa;">
                    <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">学号</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">姓名</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">专业</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">联系电话</th>
                    <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for student in advisor_students %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ student.user_code }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ student.name }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ student.major|default:'-' }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6;">{{ student.phone }}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <a href="{% url 'edit_student' student.id %}" class="btn btn-primary btn-sm" style="padding: 4px 8px; margin-right: 5px;">编辑</a>
                        <form method="post" action="{% url 'remove_student' student.id %}" style="display: inline;" onsubmit="return confirm('确定要移除该学生吗？')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-sm" style="padding: 4px 8px;">移除</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">暂无指导学生</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}